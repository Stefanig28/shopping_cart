<script>  
  async function shopifyRequest(query, variables = {}) {
    const response = await fetch("https://bu1fib-rq.myshopify.com/api/2024-10/graphql.json", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Shopify-Storefront-Access-Token": "83e93e5462232411b85e227dad586a69",
      },
      body: JSON.stringify({ query, variables }),
    });

    const data = await response.json();
    return data;
  }

  async function createCart() {
    const mutation = `
      mutation CreateCart($input: CartInput!) {
        cartCreate(input: $input) {
          cart {
            id
            checkoutUrl
            createdAt
            lines(first: 10) {
              edges {
                node {
                  id
                  quantity
                  merchandise {
                    ... on ProductVariant {
                      id
                      title
                      price {
                        amount
                        currencyCode
                      }
                    }
                  }
                }
              }
            }
          }
          userErrors {
            field
            message
          }
        }
      }
    `;
    
		const variables = {
      input: {} 
    };

    const result = await shopifyRequest(mutation, variables);

    if (result.errors || result.data.cartCreate.userErrors.length > 0) {
      console.error("GraphQL Errors:", result.errors || result.data.cartCreate.userErrors);
      throw new Error("Failed to create cart");
    }
    return result.data.cartCreate.cart.id
  }
  
  async function getCart(cartId) {
  	  const query = `
        query GetCart($cartId: ID!) {
          cart(id: $cartId) {
            id
            createdAt
            updatedAt
            totalQuantity
            lines(first: 10) {
              edges {
                node {
                  id
                  quantity
                  merchandise {
                    ... on ProductVariant {
                      id
                      title
                      price {
                        amount
                        currencyCode
                      }
                      product {
                        title
                        featuredImage {
                          url
                          altText
                        }
                      }
                    }
                  }
                }
              }
            }
            cost {
              totalAmount {
                amount
                currencyCode
              }
            }
          }
        }
      `;
      
    const variables = { cartId };
      
		const result = await shopifyRequest(query, variables);
    
    if (result.errors) {
      console.error("GraphQL errors:", result.errors);
      throw new Error("Failed to fetch cart.");
  	}
		
    console.log("Get Cart", result.data.cart)
  	return result.data.cart;
  }

  async function showCart(cartId) {
    console.log(cartId);
    const cart = await getCart(cartId);
    console.log(cart);
    // const cartModal = document.getElementById('cart-modal');
  }

  function updateCartCounter(count) {
    const counterEl = document.getElementById('cart-counter');
    counterEl.textContent = count;
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const cartId = await createCart();
    window.cartId = cartId;
    console.log("cartId", cartId);
    updateCartCounter(0)
    
    const cartBtn = document.getElementById('cart-button');
    const checkoutBtn = document.getElementById('checkout-button');

    cartBtn.addEventListener('click', async () => {
      showCart(cartId);
    });
  });

</script>
